#!/usr/bin/env bash

set -e

. /usr/local/share/myx.common/include/subr-universal.sh

echo "Setting up console for: $HOME"


##
## sh and bash common
##

cfg.common() {
	cat <<-EOF
		umask 002
		export EDITOR='nano'
		export PROMPT_COMMAND='history -w; history -r'
		export HISTCONTROL=erasedups
		export CLICOLOR='YES'
		export LSCOLORS='ExGxFxdxCxDxDxhbadExEx'
		export GREP_OPTIONS='--color=auto'
		export GREP_COLOR='00;38;5;157'
		export INPUTRC=~/.myx/etc/inputrc
		export LOCALE=en_US.UTF-8
		export LANG=en_US.UTF-8
		# ll() { ls -al "\$@"; }
	EOF
}

##
## interactive
##

cfg.shrc() {
	cfg.common
	cat <<-EOF
		PS1="\$(whoami)@\\H:\\w \\$ "
	EOF
}

cfg.bashrc() {
	cfg.common
	cat <<-EOF
		ll() { ls -al "\$@"; }
		PS1='\[\e[0;32m\]\u@\$(hostname)\[\e[m\]:\[\e[0;34m\]\w\[\e[m\]\[\e[0;32m\]\$\[\e[m\] \[\e[0m\]'
		complete -W '\`cd /usr/local/share/myx.common/bin && find . -type f | sed "s,\./,,g" | sort\`' myx.common
	EOF
}

cfg.cshrc() {
	cat <<-EOF
		setenv EDITOR nano
		setenv LANG en_US.UTF-8
	EOF
}

##
## login
##

cfg.profile() {
	cfg.shrc
	cat <<-EOF
		[ -x /usr/local/bin/screen ] && [ "\$TERM" != screen ] && /usr/local/bin/screen -s /usr/local/bin/bash -q -O -U -D -R
	EOF
}

cfg.bash_profile() {
	cfg.bashrc
	cat <<-EOF
		[ -x /usr/local/bin/screen ] && [ "\$TERM" != screen ] && /usr/local/bin/screen -s /usr/local/bin/bash -q -O -U -D -R
	EOF
}

# tcsh login & csh login
cfg.tcsh_profile() {
	cfg.cshrc
	cat <<-EOF
		[ -x /usr/local/bin/screen ] && [ "\$TERM" != screen ] && /usr/local/bin/screen -s /usr/local/bin/bash -q -O -U -D -R
	EOF
}

mkdir -p "$HOME/.myx/etc"

# inputrc
cat > "$HOME/.myx/etc/inputrc" <<-EOF
	set mark-symlinked-directories on
	set meta-flag on
	set input-meta on
	set convert-meta off
	set output-meta on
	"\e[1~": beginning-of-line
	"\e[4~": end-of-line
	"\e[5~": beginning-of-history
	"\e[6~": end-of-history
	"\e[3~": delete-char
	"\e[2~": quoted-insert
	"\e[5C": forward-word
	"\e[5D": backward-word
EOF

# interactive
AddScriptInclude "$HOME/.shrc" "$HOME/.myx/etc/shrc" "`cfg.shrc`"
AddScriptInclude "$HOME/.bashrc" "$HOME/.myx/etc/bashrc" "`cfg.bashrc`"
AddScriptInclude "$HOME/.cshrc" "$HOME/.myx/etc/cshrc" "`cfg.cshrc`" "source"

# login
AddScriptInclude "$HOME/.profile" "$HOME/.myx/etc/profile" "`cfg.profile`"
AddScriptInclude "$HOME/.bash_profile" "$HOME/.myx/etc/bash_profile" "`cfg.bash_profile`"
AddScriptInclude "$HOME/.login" "$HOME/.myx/etc/csh_profile" "`cfg.tcsh_profile`" "source"

echo "The user needs to login again for login scripts to be run"
echo "run to apply login scripts now: source $HOME/.myx/etc/bash_profile"
